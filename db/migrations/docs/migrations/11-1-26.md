-- ================================================
-- Migration: Job Logs + Activity Feed Tables
-- ================================================
-- ×ª××¨×™×š: 11/01/2026
-- ××˜×¨×”: ×˜×‘×œ××•×ª ×œ-Jobs ×•-Real-time Features
-- ================================================

-- =============================================
-- PART 1: Job Logs Table
-- =============================================
-- ================================================
-- Migration: Job Logs + Activity Feed ONLY
-- ================================================
-- ×ª××¨×™×š: 11/01/2026
-- ××˜×¨×”: ×¨×§ ×˜×‘×œ××•×ª ×œ-Jobs ×•-Activity Feed
-- ×’×™×©×”: ××™× ×™××œ×™×ª - ×¨×§ ××” ×©×—×¡×¨!
-- ================================================

-- =============================================
-- PART 1: Job Logs Table
-- =============================================

CREATE TABLE IF NOT EXISTS job_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  job_name VARCHAR(100) NOT NULL,
  status VARCHAR(20) DEFAULT 'success' CHECK (status IN ('success', 'failed', 'running')),
  metadata JSONB,
  executed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT job_logs_job_name_not_empty CHECK (job_name != '')
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_job_logs_job_name ON job_logs(job_name);
CREATE INDEX IF NOT EXISTS idx_job_logs_status ON job_logs(status);
CREATE INDEX IF NOT EXISTS idx_job_logs_executed_at ON job_logs(executed_at DESC);
CREATE INDEX IF NOT EXISTS idx_job_logs_created_at ON job_logs(created_at DESC);

-- RLS
ALTER TABLE job_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "job_logs_select_policy" ON job_logs
  FOR SELECT USING (auth.uid() IS NOT NULL);

CREATE POLICY "job_logs_insert_policy" ON job_logs
  FOR INSERT WITH CHECK (true);

-- Comment
COMMENT ON TABLE job_logs IS 'Logs for automated job executions';

-- =============================================
-- PART 2: Activity Feed Table
-- =============================================

CREATE TABLE IF NOT EXISTS activity_feed (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  account_id VARCHAR(255),
  activity_type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  severity VARCHAR(20) DEFAULT 'info' CHECK (severity IN ('info', 'warning', 'error', 'success')),
  metadata JSONB,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_activity_feed_user_id ON activity_feed(user_id);
CREATE INDEX IF NOT EXISTS idx_activity_feed_created_at ON activity_feed(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_activity_feed_read ON activity_feed(read);
CREATE INDEX IF NOT EXISTS idx_activity_feed_severity ON activity_feed(severity);

-- RLS
ALTER TABLE activity_feed ENABLE ROW LEVEL SECURITY;

CREATE POLICY "activity_feed_select_policy" ON activity_feed
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "activity_feed_insert_policy" ON activity_feed
  FOR INSERT WITH CHECK (true);

CREATE POLICY "activity_feed_update_policy" ON activity_feed
  FOR UPDATE USING (auth.uid() = user_id);

-- Comment
COMMENT ON TABLE activity_feed IS 'User activity feed';

-- =============================================
-- PART 3: Enable Realtime (Only Existing Tables)
-- =============================================

-- Enable for activity_feed (new table)
ALTER PUBLICATION supabase_realtime ADD TABLE activity_feed;

-- Try to enable for other tables if they exist
DO $$ 
DECLARE
  table_to_add TEXT;
BEGIN
  FOR table_to_add IN 
    SELECT unnest(ARRAY['detections', 'campaigns', 'baseline_stats', 'detection_state'])
  LOOP
    -- Check if table exists
    IF EXISTS (
      SELECT 1 FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = table_to_add
    ) THEN
      -- Check if not already in publication
      IF NOT EXISTS (
        SELECT 1 FROM pg_publication_tables 
        WHERE pubname = 'supabase_realtime' 
        AND schemaname = 'public' 
        AND tablename = table_to_add
      ) THEN
        EXECUTE format('ALTER PUBLICATION supabase_realtime ADD TABLE %I', table_to_add);
        RAISE NOTICE 'Added % to realtime', table_to_add;
      ELSE
        RAISE NOTICE '% already in realtime', table_to_add;
      END IF;
    ELSE
      RAISE NOTICE 'Table % does not exist, skipping', table_to_add;
    END IF;
  END LOOP;
END $$;

-- =============================================
-- PART 4: Verification
-- =============================================

-- Check what we created
SELECT 
  'job_logs' as table_name,
  EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'job_logs') as exists;

SELECT 
  'activity_feed' as table_name,
  EXISTS (SELECT 1 FROM pg_tables WHERE tablename = 'activity_feed') as exists;

-- Check realtime
SELECT 
  tablename,
  'enabled' as realtime_status
FROM pg_publication_tables
WHERE pubname = 'supabase_realtime'
AND schemaname = 'public'
ORDER BY tablename;

-- =============================================
-- Success!
-- =============================================

DO $$ 
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE '===========================================';
  RAISE NOTICE 'âœ… Migration completed successfully!';
  RAISE NOTICE '===========================================';
  RAISE NOTICE 'ğŸ“Š Created: job_logs, activity_feed';
  RAISE NOTICE 'ğŸ” RLS policies enabled';
  RAISE NOTICE 'ğŸ”´ Realtime enabled for available tables';
  RAISE NOTICE '===========================================';
  RAISE NOTICE '';
END $$;



-------------×××•×—×¨ ×™×•×ª×¨ ×¢×œ ×™××™× 45-48 --------------

